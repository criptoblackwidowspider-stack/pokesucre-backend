<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéÆ Pok√©SUCRE - Catch Pok√©mon in Tokyo</title>
    
    <!-- Leaflet Maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Montserrat', sans-serif;
            background: #1a1a2e;
            color: white;
            min-height: 100vh;
        }

        header {
            background: linear-gradient(135deg, #ff6b6b, #ffd93d);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            flex-wrap: wrap;
            gap: 10px;
        }

        .logo {
            font-family: 'Press Start 2P', cursive;
            font-size: 1rem;
            color: #1a1a2e;
            text-shadow: 2px 2px 0 white;
        }

        .wallet-info {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .balance {
            background: rgba(0,0,0,0.2);
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: 700;
            font-size: 0.85rem;
        }

        .balance span { color: #1a1a2e; }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.85rem;
        }

        .btn-connect {
            background: #1a1a2e;
            color: white;
        }

        .btn-connect:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }

        .btn-connect.connected {
            background: #10b981;
        }

        .main-container {
            display: grid;
            grid-template-columns: 1fr 380px;
            height: calc(100vh - 110px);
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .sidebar {
            background: #16213e;
            padding: 20px;
            overflow-y: auto;
        }

        .sidebar h2 {
            font-family: 'Press Start 2P', cursive;
            font-size: 0.8rem;
            color: #ffd93d;
            margin-bottom: 20px;
            text-align: center;
        }

        .pokemon-card {
            background: linear-gradient(145deg, #1f2937, #111827);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            border: 2px solid #374151;
            transition: all 0.3s;
        }

        .pokemon-card:hover {
            border-color: #ffd93d;
            transform: translateY(-3px);
        }

        .pokemon-card.legendary {
            border-color: #f59e0b;
            box-shadow: 0 0 20px rgba(245, 158, 11, 0.3);
        }

        .pokemon-card.captured {
            opacity: 0.5;
            border-color: #10b981;
        }

        .pokemon-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 10px;
        }

        .pokemon-sprite {
            width: 70px;
            height: 70px;
            background: #374151;
            border-radius: 10px;
            overflow: hidden;
        }

        .pokemon-sprite img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .pokemon-info h3 {
            font-size: 1rem;
            margin-bottom: 5px;
        }

        .pokemon-info .type {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 10px;
            font-size: 0.65rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .type-electric { background: #fcd34d; color: #1a1a2e; }
        .type-fire { background: #f87171; color: white; }
        .type-water { background: #60a5fa; color: white; }
        .type-grass { background: #4ade80; color: #1a1a2e; }
        .type-psychic { background: #e879f9; color: white; }
        .type-dragon { background: #818cf8; color: white; }
        .type-normal { background: #9ca3af; color: #1a1a2e; }
        .type-ghost { background: #a855f7; color: white; }

        .pokemon-stats {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            font-size: 0.75rem;
            color: #9ca3af;
        }

        .pokemon-location {
            font-size: 0.7rem;
            color: #6b7280;
            margin-bottom: 10px;
        }

        .pokemon-location::before { content: 'üìç '; }

        .capture-cost {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 217, 61, 0.1);
            padding: 10px;
            border-radius: 10px;
        }

        .cost {
            font-weight: 700;
            color: #ffd93d;
        }

        .btn-capture {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 8px 20px;
            font-size: 0.75rem;
        }

        .btn-capture:hover {
            box-shadow: 0 5px 20px rgba(16, 185, 129, 0.4);
        }

        .btn-capture:disabled {
            background: #4b5563;
            cursor: not-allowed;
        }

        .my-pokemon {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #374151;
        }

        .my-pokemon h3 {
            font-family: 'Press Start 2P', cursive;
            font-size: 0.6rem;
            color: #10b981;
            margin-bottom: 15px;
        }

        .captured-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .captured-pokemon {
            width: 60px;
            height: 60px;
            background: linear-gradient(145deg, #1f2937, #111827);
            border-radius: 10px;
            overflow: hidden;
            border: 2px solid #374151;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .captured-pokemon img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .captured-pokemon:hover {
            border-color: #10b981;
            transform: scale(1.1);
        }

        /* Modals */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            padding: 20px;
        }

        .modal-overlay.show { display: flex; }

        .modal {
            background: linear-gradient(145deg, #1f2937, #111827);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            max-width: 400px;
            width: 100%;
            border: 3px solid #ffd93d;
            animation: bounce 0.5s;
        }

        @keyframes bounce {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }

        .modal .pokemon-big {
            width: 150px;
            height: 150px;
            margin: 0 auto 20px;
        }

        .modal .pokemon-big img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .modal h2 {
            font-family: 'Press Start 2P', cursive;
            font-size: 0.9rem;
            color: #ffd93d;
            margin-bottom: 10px;
        }

        .modal p {
            color: #9ca3af;
            margin-bottom: 15px;
            font-size: 0.9rem;
        }

        .modal .btn { margin: 5px; }

        .btn-cancel {
            background: #4b5563;
            color: white;
        }

        .cost-box {
            background: rgba(255,217,61,0.1);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .cost-box .label {
            font-size: 0.8rem;
            color: #9ca3af;
        }

        .cost-box .amount {
            font-size: 1.8rem;
            color: #ffd93d;
            font-weight: 700;
            margin: 10px 0;
        }

        .cost-box .hbar-logo {
            font-size: 0.9rem;
            color: #6b7280;
        }

        /* Loading */
        .loading-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.95);
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 3000;
        }

        .loading-overlay.show { display: flex; }

        .pokeball-spin {
            width: 80px;
            height: 80px;
            border: 8px solid #fff;
            border-top-color: #ff0000;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-family: 'Press Start 2P', cursive;
            font-size: 0.8rem;
            margin-top: 30px;
            color: #ffd93d;
            text-align: center;
        }

        /* Success */
        .success-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.95);
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 3000;
        }

        .success-overlay.show { display: flex; }

        .success-overlay .pokemon-big {
            width: 180px;
            height: 180px;
            animation: celebrate 0.5s ease-out;
        }

        .success-overlay .pokemon-big img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        @keyframes celebrate {
            0% { transform: scale(0) rotate(-180deg); }
            100% { transform: scale(1) rotate(0deg); }
        }

        .success-overlay h2 {
            font-family: 'Press Start 2P', cursive;
            font-size: 1.2rem;
            color: #10b981;
            margin: 20px 0;
        }

        .nft-badge {
            background: linear-gradient(135deg, #ffd93d, #f59e0b);
            color: #1a1a2e;
            padding: 10px 30px;
            border-radius: 25px;
            font-weight: 700;
            margin: 20px 0;
        }

        /* Not connected */
        .overlay-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(26, 26, 46, 0.95);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            z-index: 1000;
            border: 2px solid #ffd93d;
        }

        .overlay-message h2 {
            font-family: 'Press Start 2P', cursive;
            font-size: 0.9rem;
            color: #ffd93d;
            margin-bottom: 20px;
        }

        /* Map markers */
        .pokemon-marker {
            background: none;
            border: none;
        }

        .pokemon-marker-inner {
            width: 50px;
            height: 50px;
            filter: drop-shadow(0 3px 5px rgba(0,0,0,0.5));
            cursor: pointer;
            transition: transform 0.3s;
            animation: float 2s ease-in-out infinite;
        }

        .pokemon-marker-inner:hover {
            transform: scale(1.3);
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        /* Status bar */
        .status-bar {
            background: #0f172a;
            padding: 10px 20px;
            font-size: 0.75rem;
            color: #6b7280;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status-bar .network {
            color: #10b981;
        }

        .status-bar .network::before {
            content: 'üü¢ ';
        }

        /* Payment instructions */
        .payment-steps {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid #10b981;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            text-align: left;
        }

        .payment-steps h4 {
            color: #10b981;
            font-size: 0.8rem;
            margin-bottom: 10px;
        }

        .payment-steps ol {
            color: #9ca3af;
            font-size: 0.75rem;
            padding-left: 20px;
        }

        .payment-steps li {
            margin-bottom: 5px;
        }

        .payment-steps .address {
            background: #1a1a2e;
            padding: 8px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 0.7rem;
            color: #ffd93d;
            word-break: break-all;
            margin-top: 10px;
        }

        /* Transaction input */
        .tx-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #374151;
            border-radius: 10px;
            background: #1a1a2e;
            color: white;
            font-size: 0.8rem;
            margin: 10px 0;
        }

        .tx-input:focus {
            border-color: #ffd93d;
            outline: none;
        }

        .tx-input::placeholder {
            color: #6b7280;
        }

        /* Responsive */
        @media (max-width: 900px) {
            .main-container {
                grid-template-columns: 1fr;
                grid-template-rows: 50vh auto;
            }
            .logo { font-size: 0.8rem; }
        }
    </style>
</head>
<body>

<header>
    <div class="logo">üéÆ Pok√©SUCRE</div>
    <div class="wallet-info">
        <div class="balance" id="balanceDisplay" style="display: none;">
            <span id="hbarBalance">0</span> ‚Ñè HBAR
        </div>
        <button class="btn btn-connect" id="connectBtn" onclick="connectWallet()">
            üîó Connect Wallet
        </button>
    </div>
</header>

<div class="status-bar">
    <span>Collection: 0.0.10162863 | Backend: localhost:3002</span>
    <span class="network">Hedera Mainnet</span>
</div>

<div class="main-container">
    <div id="map"></div>
    
    <div class="sidebar">
        <h2>üóæ TOKYO POK√âMON</h2>
        <div id="pokemonList"></div>
        
        <div class="my-pokemon">
            <h3>üì¶ MY CAPTURES (NFTs)</h3>
            <div class="captured-list" id="capturedList">
                <p style="color: #6b7280; font-size: 0.75rem;">Connect wallet to see your Pok√©mon</p>
            </div>
        </div>
    </div>
</div>

<!-- Not Connected -->
<div class="overlay-message" id="notConnected">
    <h2>üéÆ CONNECT TO PLAY</h2>
    <p style="color: #9ca3af; margin-bottom: 20px;">Enter your Hedera account to start catching Pok√©mon!</p>
    <input type="text" class="tx-input" id="accountInput" placeholder="0.0.XXXXXX" style="max-width: 250px;">
    <br><br>
    <button class="btn btn-connect" onclick="connectWallet()">üîó Connect</button>
</div>

<!-- Capture Modal -->
<div class="modal-overlay" id="captureModal">
    <div class="modal">
        <div class="pokemon-big" id="modalPokemon"></div>
        <h2 id="modalName">PICHU</h2>
        <p id="modalLocation">üìç Shibuya Crossing</p>
        <p id="modalEvolves" style="color: #f59e0b; font-size: 0.8rem;">Evolves to Pikachu in 30 days!</p>
        
        <div class="cost-box">
            <p class="label">Capture Cost</p>
            <p class="amount" id="modalCost">5 ‚Ñè</p>
            <p class="hbar-logo">HBAR</p>
        </div>
        
        <div class="payment-steps">
            <h4>üìã How to capture:</h4>
            <ol>
                <li>Open <strong>HashPack</strong></li>
                <li>Send <strong id="payAmount">5</strong> HBAR to:</li>
            </ol>
            <div class="address">0.0.10154386</div>
            <ol start="3">
                <li>Copy the <strong>Transaction ID</strong></li>
                <li>Paste it below and click CAPTURE</li>
            </ol>
        </div>
        
        <input type="text" class="tx-input" id="txIdInput" placeholder="Transaction ID (0.0.XXXXX@XXXX.XXXX)">
        
        <button class="btn btn-capture" onclick="confirmCapture()" id="btnConfirmCapture">‚ö° CAPTURE!</button>
        <button class="btn btn-cancel" onclick="closeModal()">Cancel</button>
    </div>
</div>

<!-- Loading -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="pokeball-spin"></div>
    <p class="loading-text" id="loadingText">Verifying payment...</p>
</div>

<!-- Success -->
<div class="success-overlay" id="successOverlay">
    <div class="pokemon-big" id="successPokemon"></div>
    <h2>GOTCHA!</h2>
    <p style="color: #9ca3af;" id="successName">PICHU was caught!</p>
    <div class="nft-badge">‚ú® NFT RECEIVED!</div>
    <p style="color: #6b7280; font-size: 0.8rem;" id="successSerial">Serial #1</p>
    <button class="btn btn-connect" onclick="closeSuccess()" style="margin-top: 20px;">AWESOME!</button>
</div>

<!-- Error Modal -->
<div class="modal-overlay" id="errorModal">
    <div class="modal" style="border-color: #f87171;">
        <h2 style="color: #f87171;">‚ùå ERROR</h2>
        <p id="errorMessage">Something went wrong</p>
        <button class="btn btn-cancel" onclick="closeError()">Close</button>
    </div>
</div>

<script>
// ============================================
// CONFIGURATION
// ============================================
const CONFIG = {
    BACKEND_URL: "http://localhost:3002",
    NFT_COLLECTION_ID: "0.0.10162863",
    TREASURY_ACCOUNT: "0.0.10154386"
};

// Datos de Pok√©mon (sincronizado con backend)
const pokemonData = [
    {
        serial: 1,
        name: "Pichu",
        evolvesTo: "Pikachu",
        image: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/172.png",
        type: "electric",
        location: "Shibuya Crossing",
        lat: 35.6595,
        lng: 139.7004,
        cost: 5,
        rarity: "common"
    },
    {
        serial: 2,
        name: "Charmander",
        evolvesTo: "Charizard",
        image: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/4.png",
        type: "fire",
        location: "Tokyo Tower",
        lat: 35.6586,
        lng: 139.7454,
        cost: 10,
        rarity: "rare"
    },
    {
        serial: 3,
        name: "Squirtle",
        evolvesTo: "Blastoise",
        image: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/7.png",
        type: "water",
        location: "Ueno Park Lake",
        lat: 35.7147,
        lng: 139.7713,
        cost: 10,
        rarity: "rare"
    },
    {
        serial: 4,
        name: "Bulbasaur",
        evolvesTo: "Venusaur",
        image: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/1.png",
        type: "grass",
        location: "Shinjuku Gyoen",
        lat: 35.6852,
        lng: 139.7100,
        cost: 10,
        rarity: "rare"
    },
    {
        serial: 5,
        name: "Mew",
        evolvesTo: "Mewtwo",
        image: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/151.png",
        type: "psychic",
        location: "Akihabara",
        lat: 35.7023,
        lng: 139.7745,
        cost: 50,
        rarity: "legendary"
    },
    {
        serial: 6,
        name: "Dratini",
        evolvesTo: "Dragonite",
        image: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/147.png",
        type: "dragon",
        location: "Senso-ji Temple",
        lat: 35.7148,
        lng: 139.7967,
        cost: 30,
        rarity: "legendary"
    },
    {
        serial: 7,
        name: "Munchlax",
        evolvesTo: "Snorlax",
        image: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/446.png",
        type: "normal",
        location: "Yoyogi Park",
        lat: 35.6715,
        lng: 139.6967,
        cost: 8,
        rarity: "rare"
    },
    {
        serial: 8,
        name: "Gastly",
        evolvesTo: "Gengar",
        image: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/92.png",
        type: "ghost",
        location: "Harajuku",
        lat: 35.6702,
        lng: 139.7027,
        cost: 8,
        rarity: "rare"
    }
];

// State
let isConnected = false;
let walletAddress = "";
let hbarBalance = 0;
let capturedPokemon = [];
let selectedPokemon = null;
let map;

// ============================================
// INITIALIZE MAP
// ============================================
function initMap() {
    map = L.map('map').setView([35.6762, 139.7003], 12);
    
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '¬©OpenStreetMap, ¬©CartoDB',
        maxZoom: 19
    }).addTo(map);
    
    pokemonData.forEach(pokemon => {
        const icon = L.divIcon({
            className: 'pokemon-marker',
            html: `<img src="${pokemon.image}" class="pokemon-marker-inner" alt="${pokemon.name}">`,
            iconSize: [50, 50],
            iconAnchor: [25, 25]
        });
        
        const marker = L.marker([pokemon.lat, pokemon.lng], { icon })
            .addTo(map)
            .on('click', () => openCaptureModal(pokemon));
        
        pokemon.marker = marker;
    });
}

// ============================================
// RENDER UI
// ============================================
function renderPokemonList() {
    const list = document.getElementById('pokemonList');
    list.innerHTML = '';
    
    pokemonData.forEach(pokemon => {
        const isCaptured = capturedPokemon.includes(pokemon.serial);
        
        const card = document.createElement('div');
        card.className = `pokemon-card ${pokemon.rarity === 'legendary' ? 'legendary' : ''} ${isCaptured ? 'captured' : ''}`;
        card.innerHTML = `
            <div class="pokemon-header">
                <div class="pokemon-sprite">
                    <img src="${pokemon.image}" alt="${pokemon.name}">
                </div>
                <div class="pokemon-info">
                    <h3>${pokemon.name}</h3>
                    <span class="type type-${pokemon.type}">${pokemon.type}</span>
                </div>
            </div>
            <div class="pokemon-stats">
                <span>‚Üí ${pokemon.evolvesTo}</span>
                <span>${pokemon.rarity.toUpperCase()}</span>
            </div>
            <div class="pokemon-location">${pokemon.location}</div>
            <div class="capture-cost">
                <span class="cost">${pokemon.cost} ‚Ñè</span>
                ${isCaptured 
                    ? '<span style="color: #10b981;">‚úÖ CAPTURED</span>'
                    : `<button class="btn btn-capture" onclick="openCaptureModal(pokemonData[${pokemonData.indexOf(pokemon)}])" ${!isConnected ? 'disabled' : ''}>CATCH</button>`
                }
            </div>
        `;
        list.appendChild(card);
    });
}

function renderCaptured() {
    const list = document.getElementById('capturedList');
    
    if (!isConnected) {
        list.innerHTML = '<p style="color: #6b7280; font-size: 0.75rem;">Connect wallet to see your Pok√©mon</p>';
        return;
    }
    
    if (capturedPokemon.length === 0) {
        list.innerHTML = '<p style="color: #6b7280; font-size: 0.75rem;">No Pok√©mon captured yet!</p>';
        return;
    }
    
    list.innerHTML = '';
    capturedPokemon.forEach(serial => {
        const pokemon = pokemonData.find(p => p.serial === serial);
        if (pokemon) {
            const div = document.createElement('div');
            div.className = 'captured-pokemon';
            div.innerHTML = `<img src="${pokemon.image}" alt="${pokemon.name}">`;
            div.title = pokemon.name + ' (NFT #' + serial + ')';
            list.appendChild(div);
        }
    });
}

// ============================================
// WALLET CONNECTION
// ============================================
async function connectWallet() {
    const input = document.getElementById('accountInput');
    const accountId = input ? input.value.trim() : '';
    
    if (!accountId || !accountId.match(/^0\.0\.\d+$/)) {
        alert('Please enter a valid Hedera account ID (0.0.XXXXX)');
        return;
    }
    
    showLoading("Connecting...");
    
    try {
        // Fetch balance from Mirror Node
        const response = await fetch(`https://mainnet.mirrornode.hedera.com/api/v1/accounts/${accountId}`);
        
        if (!response.ok) {
            throw new Error("Account not found");
        }
        
        const data = await response.json();
        hbarBalance = (data.balance.balance / 100000000).toFixed(2);
        
        isConnected = true;
        walletAddress = accountId;
        
        document.getElementById('notConnected').style.display = 'none';
        document.getElementById('balanceDisplay').style.display = 'block';
        document.getElementById('hbarBalance').textContent = hbarBalance;
        document.getElementById('connectBtn').textContent = '‚úÖ ' + accountId;
        document.getElementById('connectBtn').classList.add('connected');
        
        // Load captured Pokemon from backend
        await loadUserPokemon();
        
        hideLoading();
        renderPokemonList();
        renderCaptured();
        
    } catch (error) {
        hideLoading();
        alert('Error: ' + error.message);
    }
}

async function loadUserPokemon() {
    try {
        // Check NFTs from Mirror Node
        const response = await fetch(
            `https://mainnet.mirrornode.hedera.com/api/v1/accounts/${walletAddress}/nfts?token.id=${CONFIG.NFT_COLLECTION_ID}`
        );
        const data = await response.json();
        
        if (data.nfts) {
            capturedPokemon = data.nfts.map(nft => parseInt(nft.serial_number));
        }
    } catch (error) {
        console.error("Error loading NFTs:", error);
    }
}

// ============================================
// CAPTURE FLOW
// ============================================
function openCaptureModal(pokemon) {
    if (!isConnected) {
        alert('Please connect your wallet first!');
        return;
    }
    
    if (capturedPokemon.includes(pokemon.serial)) {
        alert('You already captured this Pok√©mon!');
        return;
    }
    
    selectedPokemon = pokemon;
    
    document.getElementById('modalPokemon').innerHTML = `<img src="${pokemon.image}" alt="${pokemon.name}">`;
    document.getElementById('modalName').textContent = pokemon.name.toUpperCase();
    document.getElementById('modalLocation').textContent = 'üìç ' + pokemon.location;
    document.getElementById('modalEvolves').textContent = `Evolves to ${pokemon.evolvesTo} in 30 days!`;
    document.getElementById('modalCost').textContent = pokemon.cost + ' ‚Ñè';
    document.getElementById('payAmount').textContent = pokemon.cost;
    document.getElementById('txIdInput').value = '';
    
    document.getElementById('captureModal').classList.add('show');
}

function closeModal() {
    document.getElementById('captureModal').classList.remove('show');
    selectedPokemon = null;
}

async function confirmCapture() {
    if (!selectedPokemon) return;
    
    const txId = document.getElementById('txIdInput').value.trim();
    
    if (!txId) {
        alert('Please enter the Transaction ID from HashPack');
        return;
    }
    
    closeModal();
    showLoading("Verifying payment...");
    
    try {
        // Call backend to verify and transfer NFT
        const response = await fetch(`${CONFIG.BACKEND_URL}/capture`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                serial: selectedPokemon.serial,
                buyerAccountId: walletAddress,
                transactionId: txId
            })
        });
        
        const result = await response.json();
        
        if (!response.ok) {
            throw new Error(result.error || 'Capture failed');
        }
        
        hideLoading();
        
        // Add to captured list
        capturedPokemon.push(selectedPokemon.serial);
        
        // Update balance
        hbarBalance = (parseFloat(hbarBalance) - selectedPokemon.cost).toFixed(2);
        document.getElementById('hbarBalance').textContent = hbarBalance;
        
        // Show success
        document.getElementById('successPokemon').innerHTML = `<img src="${selectedPokemon.image}" alt="${selectedPokemon.name}">`;
        document.getElementById('successName').textContent = selectedPokemon.name.toUpperCase() + ' was caught!';
        document.getElementById('successSerial').textContent = 'Serial #' + selectedPokemon.serial;
        document.getElementById('successOverlay').classList.add('show');
        
        renderPokemonList();
        renderCaptured();
        
    } catch (error) {
        hideLoading();
        showError(error.message);
    }
}

function closeSuccess() {
    document.getElementById('successOverlay').classList.remove('show');
}

function showError(message) {
    document.getElementById('errorMessage').textContent = message;
    document.getElementById('errorModal').classList.add('show');
}

function closeError() {
    document.getElementById('errorModal').classList.remove('show');
}

// ============================================
// UTILITIES
// ============================================
function showLoading(text) {
    document.getElementById('loadingText').textContent = text;
    document.getElementById('loadingOverlay').classList.add('show');
}

function hideLoading() {
    document.getElementById('loadingOverlay').classList.remove('show');
}

// ============================================
// INIT
// ============================================
window.onload = function() {
    initMap();
    renderPokemonList();
    renderCaptured();
};
</script>

</body>
</html>
